<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>D2 Interactive Storyteller</title>
    <script src="https://cdn.jsdelivr.net/npm/svg-pan-zoom@3.6.1/dist/svg-pan-zoom.min.js"></script>
    <style>
        :root { --accent: #007aff; --bg: #f5f5f7; }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; display: flex; height: 100vh; background: var(--bg); }
        
        /* UI Layout */
        #viewer { flex-grow: 1; position: relative; overflow: hidden; display: flex; flex-direction: column; }
        #sidebar { width: 350px; background: white; border-left: 1px solid #d2d2d7; display: flex; flex-direction: column; box-shadow: -5px 0 15px rgba(0,0,0,0.03); }
        
        /* Interactive Controls */
        .toolbar { position: absolute; top: 20px; left: 20px; z-index: 10; display: flex; gap: 8px; background: rgba(255,255,255,0.8); backdrop-filter: blur(10px); padding: 5px; border-radius: 8px; border: 1px solid #d2d2d7; }
        button { border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 500; transition: 0.2s; background: transparent; }
        button.active { background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); color: var(--accent); }
        
        /* Content Styling */
        #svg-canvas { flex-grow: 1; cursor: grab; }
        #svg-canvas:active { cursor: grabbing; }
        .details-pane { padding: 30px; overflow-y: auto; }
        .annotation-card { background: #f9f9f9; border-radius: 12px; padding: 15px; border: 1px solid #e5e5e5; margin-top: 20px; display: none; }
        
        /* Filtering Logic */
        .dim { opacity: 0.15 !important; filter: grayscale(1); transition: all 0.4s ease; }
        .highlight { stroke: var(--accent) !important; stroke-width: 3px !important; transition: all 0.4s ease; }
    </style>
</head>
<body>

<div id="viewer">
    <div class="toolbar" id="filters">
        <button class="active" onclick="applyFilter('all', this)">Full View</button>
        <button onclick="applyFilter('auth-flow', this)">Auth Flow</button>
        <button onclick="applyFilter('data-sync', this)">Data Sync</button>
    </div>
    <div id="svg-canvas"></div>
</div>

<div id="sidebar">
    <div class="details-pane">
        <h2 id="node-title">System Overview</h2>
        <p id="node-desc">Click any component to inspect its architecture and notes.</p>
        <div id="annotation-box" class="annotation-card"></div>
    </div>
</div>

<script>
// 1. D2 CODE (The Master Diagram)
// We use 'class' to tag elements for our storytelling filters
const d2Source = `
direction: right
vars: {
  d2-config: { layout-engine: elk; theme: 200 }
}

# NODES
User: Customer {shape: person}
Cloud: {
  AuthService: Authentication {class: auth-flow}
  APIGateway: API Gateway {class: all}
  DB: User Database {shape: cylinder; class: data-sync}
}

# CONNECTIONS
User -> Cloud.APIGateway: Request
Cloud.APIGateway -> Cloud.AuthService: Validate {class: auth-flow}
Cloud.AuthService -> Cloud.DB: Lookup {class: auth-flow}
Cloud.APIGateway -> Cloud.DB: Write Log {class: data-sync}

# STYLING CLASSES
classes: {
  auth-flow: { style: { stroke: "#007aff"; stroke-width: 2 } }
  data-sync: { style: { stroke: "#ff9500"; stroke-dasharray: 5 } }
}
`;

// 2. RENDERER ENGINE
async function init() {
    const encoded = btoa(unescape(encodeURIComponent(d2Source)));
    const response = await fetch(`https://kroki.io/d2/svg/${encoded}`);
    const svgText = await response.text();
    const container = document.getElementById('svg-canvas');
    container.innerHTML = svgText;

    const svgEl = container.querySelector('svg');
    svgEl.setAttribute('width', '100%');
    svgEl.setAttribute('height', '100%');

    // Enable Smooth Zoom/Pan
    const panZoom = svgPanZoom(svgEl, {
        zoomEnabled: true,
        controlIconsEnabled: false,
        fit: true,
        center: true,
        minZoom: 0.5,
        maxZoom: 10
    });

    // Handle Interactivity
    svgEl.querySelectorAll('g[id]').forEach(node => {
        node.style.cursor = 'pointer';
        node.onclick = () => {
            const id = node.id.replace('d2-', '').split('.').pop();
            inspectNode(id);
        };
    });
}

// 3. STORYTELLING & FILTERING
function applyFilter(className, btn) {
    // UI Update
    document.querySelectorAll('#filters button').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    const allElements = document.querySelectorAll('g[class*="d2-"]');
    
    allElements.forEach(el => {
        if (className === 'all') {
            el.classList.remove('dim');
        } else {
            // Check if the element has the specific class in its D2 metadata
            const isMatch = el.getAttribute('class').includes(className);
            el.classList.toggle('dim', !isMatch);
        }
    });
}

// 4. ANNOTATION SYSTEM
function inspectNode(id) {
    const db = {
        'AuthService': { title: 'Auth Service', desc: 'Node.js/Passport.js handler.', note: 'Current Latency: 45ms' },
        'DB': { title: 'Main Database', desc: 'PostgreSQL 16 Cluster.', note: 'Capacity: 80% used' },
        'APIGateway': { title: 'Gateway', desc: 'NGINX Ingress Controller.', note: 'Rate limiting active.' }
    };

    const data = db[id] || { title: id, desc: 'Internal System Component', note: 'No specific alerts.' };
    
    document.getElementById('node-title').innerText = data.title;
    document.getElementById('node-desc').innerText = data.desc;
    const box = document.getElementById('annotation-box');
    box.style.display = 'block';
    box.innerHTML = `<strong>Note:</strong><br>${data.note}`;
}

init();
</script>
</body>
</html>