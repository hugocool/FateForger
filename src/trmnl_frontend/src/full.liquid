<div class="layout">
  <div class="title_bar">
    <span class="title">TIMEBOX</span>
    <span class="instance">{{ meta.today_label }} • {{ meta.now_window }}</span>
  </div>

  <div class="grid grid--cols-5 gap">
    <!-- LEFT PANE (3/5) -->
    <div class="col col--span-3 flex flex--col gap">

      <!-- DAY ANCHOR (coarse, stable) -->
      <div class="progress-bar progress-bar--small">
        <div class="content">
          <span class="label label--small">DAY ANCHOR</span>
          <span class="value value--xxsmall">{{ day.start_local }}–{{ day.end_local }} • slice {{ day.current_slice }}/{{ day.total_slices }}</span>
        </div>
        <div class="track">
          <div class="fill" style="width: {{ day.progress_pct }}%"></div>
        </div>
      </div>

      <!-- NOW BLOCK (no second-by-second clock; all coarse) -->
      <div class="item item--emphasis-3">
        <div class="meta">
          <span class="label label--small label--underline">{{ now.event_type }}</span>
          <span class="label label--small label--underline">{{ now.starts_local }}–{{ now.ends_local }}</span>
          <span class="label label--small label--underline">{{ now.remaining_range_label }} left</span>
        </div>
        <div class="content">
          <span class="title title--large" data-clamp="1">{{ now.block_title }}</span>
          <span class="description" data-clamp="1">{{ now.subtitle }}</span>
        </div>
      </div>

      <!-- 5-MINUTE PROGRESSION INSIDE THE CURRENT BLOCK -->
      <div class="progress-dots progress-dots--large">
        <div class="track">
          {% for dot in now.block_dots %}
            {% if dot == "filled" %}
              <div class="dot dot--filled"></div>
            {% elsif dot == "current" %}
              <div class="dot dot--current"></div>
            {% else %}
              <div class="dot"></div>
            {% endif %}
          {% endfor %}
        </div>
      </div>

      <span class="description description--small" data-clamp="2">{{ now.bucket_hint }}</span>

      <div class="divider"></div>

      <!-- UP NEXT -->
      <div class="item item--emphasis-1">
        <div class="meta">
          <span class="label label--small label--underline">UP NEXT</span>
          <span class="label label--small label--underline">{{ next.starts_local }}</span>
          <span class="label label--small label--underline">{{ next.event_type }}</span>
        </div>
        <div class="content">
          <span class="title title--small" data-clamp="1">{{ next.title }}</span>
          <span class="description" data-clamp="1">{{ next.subtitle }}</span>
        </div>
      </div>

      <div class="divider"></div>

      <!-- FOOTER: SYNC STATE (explicitly coarse) -->
      <div class="flex flex--row gap--small">
        <span class="label label--small">SNAPSHOT</span>
        <span class="label label--small label--underline">{{ meta.snapshot_local }}</span>
        <span class="label label--small">NEXT</span>
        <span class="label label--small label--underline">{{ meta.next_refresh_local }}</span>
        <span class="label label--small">({{ meta.refresh_minutes }}m)</span>
      </div>
    </div>

    <!-- RIGHT PANE (2/5) -->
    <div class="col col--span-2 flex flex--col gap">

      <!-- METRICS -->
      <div class="progress-bar progress-bar--emphasis-3">
        <div class="content">
          <span class="label">DEEP WORK</span>
          <span class="value value--xxsmall">{{ metrics.deepwork.label_right }}</span>
        </div>
        <div class="track">
          <div class="fill" style="width: {{ metrics.deepwork.progress_pct }}%"></div>
        </div>
      </div>

      <div class="progress-bar">
        <div class="content">
          <span class="label">TASK VELOCITY</span>
          <span class="value value--xxsmall">{{ metrics.tasks.label_right }}</span>
        </div>
        <div class="track">
          <div class="fill" style="width: {{ metrics.tasks.progress_pct }}%"></div>
        </div>
      </div>

      <div class="divider"></div>

      <!-- PIPELINE -->
      <div class="flex flex--row flex--justify-between">
        <span class="label">PIPELINE</span>
        <span class="label label--underline">{{ pipeline.source_label }}</span>
      </div>

      <div class="flex flex--col gap" data-overflow="true" data-overflow-counter="true">
        {% for t in pipeline.items %}
          <div class="item item--emphasis-{{ t.emphasis }}">
            <div class="meta">
              <span class="index">
                {% if t.status == "done" %}✓{% elsif t.status == "next" %}→{% else %}·{% endif %}
              </span>
            </div>
            <div class="content">
              <span class="title title--small" data-clamp="1">{{ t.title }}</span>
              <div class="flex gap--small">
                {% for tag in t.tags %}
                  <span class="label label--small label--underline">{{ tag }}</span>
                {% endfor %}
                <span class="label label--small label--underline">{{ t.est_min }}m</span>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>

      <div class="divider"></div>

      <!-- MICRO-STEPS -->
      <span class="label">{{ microsteps.title }}</span>

      <div class="flex flex--col gap" data-overflow="true">
        {% for s in microsteps.items %}
          <div class="item item--emphasis-1">
            <div class="meta">
              <span class="index">
                {% if s.status == "done" %}✓{% elsif s.status == "doing" %}→{% else %}·{% endif %}
              </span>
            </div>
            <div class="content">
              <span class="title title--small" data-clamp="1">{{ s.title }}</span>
            </div>
          </div>
        {% endfor %}
      </div>

    </div>
  </div>
</div>
