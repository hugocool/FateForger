version: "3.9"

volumes:
  ticktick_data:
    driver: local
  ticktick_config:
    driver: local
  app_data:
    driver: local
  notion_data:
    driver: local
  calendar-mcp-tokens:
    driver: local
  poetry-cache:
    driver: local
networks:
  admonish-network:
    driver: bridge

x-ticktick-build: &ticktick_build
  context: https://github.com/JakobGruen/ticktick-mcp.git#feature/docker-and-http-support

x-common: &common
  build: *ticktick_build
  env_file: .env
  volumes:
    - ticktick_config:/root/.config/ticktick-mcp
    - .env:/app/.env

x-google-calendar-mcp:
  &google_calendar_mcp # Pin the google-calendar-mcp version in a single place.
  build:
    context: https://github.com/nspady/google-calendar-mcp.git#v2.0.1
    dockerfile: Dockerfile # repo root
  image: myorg/calendar-mcp:v2.0.1 # optional, for easier identification

services:
  app:
    container_name: admonish-app
    build:
      context: .
      dockerfile: Dockerfile
    env_file: .env
    volumes:
      - .:/app
      - poetry-cache:/root/.cache/pypoetry
    ports:
      - "3000:3000"
    networks:
      - admonish-network
    restart: unless-stopped
    depends_on:
      - calendar-mcp
      - ticktick-mcp
      - notion-mcp

  calendar-mcp:
    <<: *google_calendar_mcp
    # ───────────────────────────────────────────────
    # Build directly from the GitHub repo @ tag
    # ───────────────────────────────────────────────

    container_name: google-calendar-mcp
    env_file:
      - .env # Use the main .env file from project root (relative to docker-compose.yml)
    # mount your OAuth JSON (or use secrets)
    volumes:
      - type: bind
        source: ./secrets/gcal-oauth.json
        target: /app/gcp-oauth.keys.json
        read_only: true
      - calendar-mcp-tokens:/home/nodejs/.config/google-calendar-mcp

    ports:
      - "${PORT}:${PORT}"
      - "3500:3500" # OAuth authentication server port
    environment:
      TRANSPORT: "${TRANSPORT}"
      PORT: "${PORT}"
      GOOGLE_OAUTH_CREDENTIALS: "/app/gcp-oauth.keys.json"
      HOST: "0.0.0.0"

    networks:
      - admonish-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${PORT}/healthz"]
      interval: 30s
      timeout: 5s
      retries: 3

  calendar-mcp-auth:
    <<: *google_calendar_mcp
    # Auth service to get initial tokens - run once then stop
    container_name: google-calendar-mcp-auth
    profiles: ["auth"] # Only runs when specifically requested
    env_file:
      - .env
    volumes:
      - type: bind
        source: ./secrets/gcal-oauth.json
        target: /app/gcp-oauth.keys.json
        read_only: true
      - calendar-mcp-tokens:/home/nodejs/.config/google-calendar-mcp
    ports:
      - "3510:3001" # Different port for auth server
      - "3511:3002"
      - "3512:3003"
      - "3513:3004"
    environment:
      GOOGLE_OAUTH_CREDENTIALS: "/app/gcp-oauth.keys.json"
    command: ["npm", "run", "auth"]
    stdin_open: true
    tty: true
    restart: "no"
    networks:
      - admonish-network
  ticktick-mcp-auth:
    <<: *common
    profiles: ["auth"] # ← only runs when you ask for it
    container_name: ticktick-mcp-auth
    ports:
      - "8000:8000"
    command: ["/bin/sh", "-lc", "uv run -m ticktick_mcp.cli auth"]
    stdin_open: true
    tty: true
    restart: "no"

  ticktick-mcp:
    <<: *common
    container_name: ticktick-mcp
    ports:
      - "8002:8000"
    restart: unless-stopped

  # notion-mcp:
  #   <<: *common-env
  #   build:
  #     context: https://github.com/makenotion/notion-mcp-server.git#main
  #   command: >
  #     npx -y @notionhq/notion-mcp-server
  #     --transport streamable-https
  #     --port 8002
  #   environment:
  #     MCP_TRANSPORT: streamable-https
  #     NOTION_TOKEN: ${NOTION_TOKEN}
  #   ports:
  #     - "8002:8002"
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "https://localhost:8002/health"]
  #     interval: 30s
  #     timeout: 5s
  #     retries: 3

  notion-mcp:
    build:
      context: https://github.com/makenotion/notion-mcp-server.git#main
    command:
      [
        "npx",
        "-y",
        "@notionhq/notion-mcp-server",
        "--transport",
        "http",
        "--port",
        "${MCP_HTTP_PORT}",
        "--auth-token",
        "${MCP_HTTP_AUTH_TOKEN}",
      ]
    environment:
      # Notion API credential (internal integration token: ntn_...)
      NOTION_TOKEN: ${NOTION_TOKEN}
    ports:
      - "${MCP_HTTP_PORT}:${MCP_HTTP_PORT}"
    restart: unless-stopped
